import { PerformanceMark, PerformanceMeasure } from "perf_hooks";

const test_input = `???.### 1,1,3
.??..??...?##. 1,1,3
?#?#?#?#?#?#?#? 1,3,1,6
????.#...#... 4,1,1
????.######..#####. 1,6,5
?###???????? 3,2,1`.split("\n");

const puzzle_input = `??.?#??#?#??##???? 2,4,6,1
?????#?..?#? 2,2,2
???#???#.?#?????.# 5,1,1,1,2,1
???#???#.#??#??##?? 1,1,1,1,9
????###??.????#.# 5,1,2,1
.?##?##?.?????#?#?. 6,6
?????#???#??#???? 3,8
???#????.?? 3,1,1
?#?#???????#?#?.. 5,4
??????##????.#?? 1,9,1,1
#??????..???#?????? 2,4,1,3,1
.#.???.#?#?#??##??. 1,1,5,4
??????#.?????#?#???. 5,1,1,6,1
#?????###??#?. 1,7,2
.???????#. 1,6
??#?#..?... 4,1
?##?#?????##??#?# 5,2,5,1
???#.?.?#???? 1,1,1,6
#????.??.?. 4,1
??##??#???? 4,1,1
?#???#??????????? 1,9,1
??????..??????#?#?# 1,2,1,1,6,1
?.?.#?#?#??????#??. 1,1,5,3,1,1
#???.????.??? 3,2,2
.????????#??##??#??? 1,13,1
????#??????. 1,2,3
..?##.????#? 3,1,1
??##??##?#???? 1,11
???????????#???????? 6,5,1,1
?####?#??#?.. 7,1
.??#?#??##??????.##? 11,3
???????????? 2,2,1,1
??????.?.?????? 4,3
?#.??#??.?#??? 1,2,1,1
???????..??? 2,1,1
???.#?.?????. 1,1,4
?#??.?..?#???... 2,5
.#?.#?#.?????..##??? 1,1,1,1,1,5
???.?.?..?.???#. 3,1,1,2
??????????.?..#??? 2,2
?#???##????#?.?????# 1,1,2,4,2,1
.?#????#?????#??. 2,1,3,5
?.##.?#?##?#.??? 2,6,2
?.???????.?.###??#?? 3,2,1,8
???#?????.??.??.#? 5,1,2,1,1
#?..???????#?#. 1,3,3,1
???#???...? 4,1
?.??#..??..???. 2,2
...????????#.? 4,4
????.????? 3,1
.???.??#?#?? 3,1,1,3
.??.#???.?#?????###? 1,4,3,5
?#?.?????????.??##.? 1,2,4,2
???.???#..??.?? 2,1,1,1,1
???#????##?????.#? 6,2,3,1
?????..????##??? 3,1,7
???????.#.?????.?.?? 1,4,1,3,2
?#??????.???#?#????? 1,5,10
.??????????#?? 1,1,2,3
?#??..???#.??##.?# 1,1,1,1,4,1
???#?????.???#? 2,1,1,1,1
?.##?#???.???#?#?## 6,1,7
.??#??#?##?????? 3,4,1,1
..??.?.??? 2,1
??????#?#??#??.???# 1,1,7,1,2,1
???.?..#???#?.###?? 2,5,5
???#.#..?######.??? 1,1,1,7,1,1
??#?#..#?.?.??## 5,2,1,4
??#.#.?????#???#? 1,1,1,1,8
?????#?????.. 2,1
..?????????? 1,3,1
?.????????#.??####? 1,1,2,1,1,5
#???#?????.???#? 1,2,3,2
??.?#???????. 4,1
#?.#?#????. 1,1,5
??????#????##??? 1,9
.??.???????? 2,1,2
???.#???#?????#?? 1,1,7,2
???.##??.???#???? 1,4,4,1
???...?.??##?##..??. 7,1
?????#.?????##?##?? 1,1,9
.??.?.????. 1,2,1
??.#??????###???. 10,1
?#???#????????? 2,2,1,1,1
???.?????????#. 3,4
?..????##?????..? 1,8,1,1
?#???????# 1,1,1
??#????#?.?#?.#??.? 9,1,2
?#..?.??#.#.?#????? 1,1,2,1,1,4
?.?#.?..??# 1,1,1
??.#??.#.???#????? 1,2,1,1,3,1
??#.??#??##??.??#?. 3,3,5,1
.?.?????#???????# 1,8,1,2
?#?##?#?????##???..? 9,5
#..?..#?????#???. 1,10
??#?#??.#?????# 2,2,7
???????#??????.?#. 1,1,2,5,1
??.#???#??##???.# 1,6,4,1
?????????.?.#???#?.. 4,5
?????####.. 1,5
?#???#??#.#???.? 6,1,1,1
????.?.??.???. 2,1
?????.?#?.?#??###?? 1,1,1,3,8
??????##????#??????# 6,1,1,1,3
???.???#?.?? 1,3,1
?#??????.?#??#?#? 6,7
????????#?#?????? 1,2,1,3,3
.???.?????..# 2,1,1,1
#????????.?.? 6,1
#??###???????# 1,3,1,1
#???.?#?#?? 2,5
.???????????????# 1,3,1,4,1
????#???..#.#???.. 1,1,1,1,2,1
.?????.?#???# 2,1,4,1
???##??.???? 4,2
????????#?#?.??#?#. 1,3,3,5
?????#??#?????.?#? 11,2
???.?#?#???#? 1,9
?#???##?.?.??##??.?. 7,6
#?#.????#??#. 3,1,5
##???..????#??.? 4,6
?.?#?#?.??? 1,5,1
?#????.?#??.? 1,1,4,1
?#????#?#??#.??? 8,2,1,1
??????#????# 5,1
???????#??????????. 2,2,4
.#.?.??.??#? 1,1,1,1
?.#??.?#????#?#? 1,2,9
?.??..?.???##?.???. 2,1,3,2
?#??.?.?????? 2,1,1,1
.?#?.#.??? 1,1,1
?#???##????.?. 7,1,1
?.??????.#? 3,2
??##?.??##??.? 2,6
???##?..??? 4,1
?#?#??????.? 1,1,4,1
?#?.#?#????#.?#???## 1,1,3,1,7
???#??????#?#?##? 1,2,1,4,4
.??????.????? 1,1,2,2
??#??????###???..?#? 13,1
???#??.??????????.# 5,4,1,1,1
.?##?????????????# 3,1,2,2,2
????????## 2,2
??????.???? 1,1,3
?#.#?#??#.?#?? 1,6,2
??.?????.??..?#.#?? 1,1,2,1,1,1
?##??####?????. 4,4,1
.?#???????#??.??.? 4,3,1
??.?.?????#? 1,5
##???#?#??????.? 2,3,5,1
?#??#???#?#??#? 2,3,4,1
#????.##??.??????? 1,1,1,4,1,3
???.????.??#??# 2,3,1,1
?????????. 2,4
#??.???#???# 2,5,1
##?.#???.#..?.????#? 3,1,1,1,1,4
??#.?????#????#??? 2,1,4,3
?#?????????.???? 11,1,1
??##?????.???#??### 9,1,6
?.?###?#?.???# 7,4
?.#?##?#.##?#? 6,5
.#????#?.?? 1,3,1
????.#??#. 2,1,2
??#????????##??.? 6,6
??#.#??#?.?##..?#? 1,1,5,3,2
?.?.?#?????.?? 1,7,1
??#??#?#??#??#? 1,7,1,2
??.????.??###? 1,3,3
.#???????###????. 5,5,1
?.???????????#?? 1,1,1,1,3
.#????#.?.##????? 1,3,2,1,1
?#??????.????#?? 5,2,1,4
...#?????????.?? 3,3,1
..????#???? 2,3,1
?#????..??#.#? 1,1,3,1
??#?????##????#.???? 12,1,1,1
???#??..?#? 4,1
?????.?#????# 1,1,3,1
???#????.##?##??? 2,3,1,5,1
??#??.????? 4,1,1
?.???###??????.#?# 1,11,1,1
?#?#?????????#?#. 8,1,3
#.?.?#???????#?##?.. 1,6,6
???.????#???#? 1,1,3,2
?????????? 1,1,2
.??.??.????. 1,1,1
?###??#?###??? 10,2
???#?..??.. 4,2
#?##.##.??#??#?.???? 4,2,1,1,2,3
.??.?.????#????. 1,6
???#?#???. 4,4
??#?#???.???.???##?? 8,3,4,1
?#????##?.?.? 3,4,1,1
#?.?????#???#.?????? 1,1,1,2,2,5
#?.???#??#???? 2,2,2,1
???????.?.#?##??? 5,1,4
?????.?#.???# 2,2,3
#.?.#???????#??#.. 1,4,6
??#?#??#?#??.??????? 1,4,1,1,1,2
?.???#?.##?. 1,4,2
????????##???.?.??? 1,2,7,1
#.?.?#?#.?.?????#?#? 1,1,3,1,1,4
???..##??#????? 5,1
???..#?.?.? 2,2
?.??#?#?#??#??..? 3,8
.#????##???#????. 2,7,1
??###??#????? 3,3
#??????##.?#?? 9,2
?#?.?????? 1,1,1
?.?????#?#???#?# 8,3
?.??????#?#?#???? 1,1,3,1,6
?#.???#?..?. 1,3,1
#????#??#?. 1,2,2
?.#???#?#?? 1,5,2
?????#.???#???? 4,1,1,1
?#.??.????? 2,1,2
.#??.?????#??? 3,1,5
????..????#.?..??? 1,1,1,1,1,3
?##??????#? 3,5
??????...?# 1,2,2
.??????.?#.? 2,1,1
??????#???????#? 2,2,6
.??#????#???????.#? 1,2,6,1,1
???.???.??????#? 3,4
???#?.#????#?. 4,7
????##?#?.##?.? 1,5,2
??#??#.?#..#??.# 1,4,1,2,1
?????.?#?????#???.?? 2,8,1,1
?.???.#???.. 1,1,1,1
???#??#?##????#. 13,1
.?#?.?#?#?#????? 2,4,5
????##???#????? 1,8,1
?#?#??#?????????.?? 2,7,1,1,1,1
??????#?#?? 8,1
?.???##.#?#????#?. 1,4,9
??.?????????????..? 8,1
?#?###?..#?.?##??.? 6,2,5
????.??#??????????? 3,3,9
####.?.??.????? 4,1,1,2
.??#...?.??#? 2,3
?#??????#?# 1,7
?.???#.#?# 1,1,3
????.#??..???# 1,3,1,1
?#??#??????? 5,1
???.??.???#???????.# 1,1,9,1
??#???.?#?.????#?? 4,2,1,1
????.?#.?????#?#. 4,1,2,5
.?????#?##??????? 10,2
??#???.?.??? 4,1,1
.?????#??????###?#?? 3,12
??#?#????#?.??? 10,1
???????????? 4,1,1
???##????#?.???. 8,2,2
????##?##. 1,1,5
????#?#?#?#.?#.?? 1,1,7,1,1
?#??#?..???? 5,1
.???..???? 3,1
..???.????.##?? 3,2
??##?.#??????????# 1,2,2,2,1,2
..??.??.?##??.? 2,4
?#????#.?.#?? 7,2
??##?.???#? 2,3
?????.#??#??..? 1,2,6
.?????.?.# 3,1
??.?????#.???#? 2,1,1,1,3
#?.?.????#????.????. 2,1,7,3
??.##?#..??#??#?? 1,2,1,8
???#?.?????? 1,1,1,1
????????#?.??#. 1,5,1,1
.???##??#???#?#? 5,3,3
??#???#..???#?#?? 2,1,1,7
?#?????#???? 7,1
?????#???? 3,1,1
.????.??????#?##? 4,1,6
??.?.????? 1,3
?#?.??????? 3,1,1
?.?.??.?.?###? 1,1,1,5
?#??##????.?? 8,2
..?#???#?????? 6,2
????.????.? 2,2,1
???.???.??? 2,3
?#?#??#.##?#?. 6,2,1
.??#?????#??#?..#? 13,1
#?#??.?????#??.? 4,5
#?#?????????##?? 1,1,3,5
??#??.#?#?? 2,1,1
?###.#.??.???#.??? 3,1,2,1,1,1
?.?.?#?#???#????.??? 1,1,1,6,1,1
??.#????##???#.? 7,2
????.??????# 1,1,1,1
?????#??.?# 2,3,1
?????.???#? 1,4
?#.????#.?.#? 2,1,2,1
?.?????#??#?.. 3,2,2
#?.?????#?? 2,2,4
.????.?.#???.??? 3,1,3,1
??.????.?#???##??? 2,2,7
.?.????#??????#?? 1,1,5,1,3
??.???##?#? 1,7
#..??????.? 1,4,1
????#??#.???#??? 6,2,1
??#?.????..??..??? 3,1,2,1,1,1
#??#????#??#??? 1,10,1
??????#????????? 1,8,2
?##.??#?.? 2,2
?.#?????.?.##?#? 1,1,3,1,4
?#..?##????..?? 1,7,2
?.??#?#??.??????# 1,7,1,1,2
##???##?#??### 9,3
?#.?#?????????.?#? 1,1,2,1,1,2
.?#?.???.???? 2,3,1
.????.??#?? 1,3
??..#.??##????## 1,1,10
##.???.?#?#..??. 2,1,2,1,1
??##???##??? 5,2,1
???#????#?.? 5,2
???????.???.? 2,1,1,1
??????#?????. 2,8
?#???.?.??.?#??## 2,1,1,6
?#.????##????? 1,1,8
.??#???#?????????? 8,4
???.?#???.??????? 1,4,2
.?.??#?#???#?? 1,3,5,1
??#??.?#?????#### 3,1,6
????????#.? 1,1,1
?.?##????.?. 3,1
?.?#?????.. 3,3
.?#?#?#???#.. 6,1
.??????#???????#?.? 3,5,1,1,1
?.?.??#????#?. 1,7
???????#????#???. 6,2
.??????#????????# 1,1,1,4,1
???.?..???????#???. 1,2,7
#??????#?#.? 2,2,3,1
?????????#??????#?. 2,1,1,1,5
??????#.??#? 5,1,1,1
#?.##????? 1,3,1
..#??????#?? 1,2,2
#?#???##??.? 3,4
???#??????# 3,4,1
??.#????#?#??#???. 1,1,8,1
.????????##? 1,7
#??..????#??? 2,2,1,2
?.#??#???#????#.??? 13,2
?????..#???????? 3,3,2,2
?#????.??# 3,1,3
?#????##??#??.??#?? 3,6,1,2
????###.??????? 6,1
???#??#?#?#?####.. 1,14
???.??.#?? 2,1,2
.##???..?#? 2,2
...???#???????? 9,1
?#????#???.?#??#? 1,6,1,3
???#???????#????? 4,1,9
??????.#?? 1,2,2
#????????#?.#???? 1,5,3,1,2
???#?#??##?.??? 5,3,1
??.??##???? 1,4
???????.?????.### 5,1,1,3
???..????? 3,1,2
?###?#???#??????#??? 5,2,4
.???#??.????##?? 6,3
?#?.?????#? 1,2,3
???????.??####?????? 4,1,1,8,1
????.????? 1,1,1
???.#???####?#.? 1,1,1,6
??????##??????.?? 12,1
??#?#???#???. 6,2,1
#?#..#?#???? 3,7
???.??#?#?????#?#? 1,8,4
?##.???.#??? 3,1,1,1
????#?#?#?????#??#.. 11,1,1
??????????#?# 1,8,1
#??.?##??????#?.??? 1,10,1
.#??.###???#? 3,4,1
.??.????## 1,2,3
?????#????.??????##? 3,2,1,1,2,2
??##?????..?#??? 6,2,2,1
??????#???? 1,5
???#????????#?? 4,5
??#??.???? 2,1,1
?????..???#?# 1,5
#?.?##?#??#??.???. 1,10,1,1
?????.??..???# 2,1,1,2
.?????#???? 2,3
.????.????? 1,2
.???#.??#??#..#?? 1,1,5,1
.#?.??#????? 2,1,1,4
?.???.?.#?. 2,2
..??????#????? 1,2,3,1
.?..?#??#? 1,3,1
??.#######???? 1,8
?#??.#??#?.??? 2,4,1
.#??.?#?.?? 1,2
#??.???..???#??? 3,2,5
?.?????..???#####. 3,8
??#??#?.#? 4,1
##?.?#????# 3,1,3
????????.??# 2,1
?#??#??#???????#??? 9,4
????##????#?.? 5,3
#??##??????..? 6,2,1
?.??#..??.#??? 3,2
????????#?. 2,3
?????.?#???.?? 2,1,4,1
???????????#?? 1,1,1,6
?.?????????? 2,5
.#?.?#.??#?????# 1,2,3,3
??#.#????????? 1,5,1
?..#?.?#?# 2,3
??#??.?.????. 3,2
.??.?.##?????#?#. 1,10
???#???????? 1,1,1,3
??.??????.?.???.? 1,5,1,2,1
.??#?.?#.???? 2,2,1,1
..?????????? 2,1
.?#??????.?##???..? 6,5
?.???.#????# 1,2,1,1
???????.???.??? 2,1
????????#? 1,1,2
?#?.#????? 2,5
.???#??#?????????? 6,2
.????????##?#? 2,10
?#.?#????? 1,4
##.#?.#???????????? 2,2,7,1
??#????.??.??? 7,1,1
.?##????.??. 3,1,2
?.?###.???#????????. 4,10
?#?#???#?? 3,2
??..?#?#???? 1,3,1
??????..??.. 6,2
.?#???..#??. 4,2
??#?##????##????##?? 4,9
??#??.????#???? 4,1,1,1
.???.???#?# 1,6
#?.??#??.???? 1,1,2,1
??..??#??#??????# 1,1,1,3,2
?.??.??#.???? 1,1,1,2
???.???.?#??????.# 1,3,3,1,1
#??#??????. 4,1
?#.???.??#?.#??.?? 2,2,1,2,1,1
??.???#?????#??? 1,4,1,3
????.#??#??#???## 1,1,1,5,4
?#?.#??#?..#??##? 2,1,1,5
?##?.??????#.?. 3,4,1,1
.??.???#??.??.#?#? 1,4,2,3
???.?#????##????.#? 1,1,2,9,1
?????????#?#? 3,1,1,1
??#?????.#? 1,2,1
.???????????? 1,1,1,3
??????????.???.??.?? 1,1
#????#.????? 1,4,1
??????.?.?..#?????? 3,1,1,1,1,3
??.?????#?###??? 1,1,1,7
#.#??#????.??. 1,4,2
????.?.?#?. 3,1,2
??????#?.????? 8,1
?###??#??##?..#?..#? 12,2,2
?#??????.??.???##.?? 6,1,1,3,2
.?????????#?????# 2,9,2
??#??#?.???.? 6,1
?.?.??#????#?????. 1,1,3,2,1,1
??.?.?...? 1,1
?.?????.???.?#?#? 1,3
?.#?#??.?.?#?#?#.. 5,5
???#?#?#?????#? 9,4
?#????##?##???. 2,7
????#??.?????# 7,3,1
..?.???????? 1,1,3
?#???#??.??.#??. 7,1,3
?#???#???#??.?#? 1,2,4,1
..???.?#???#??#????# 1,1,9,1
??##?????# 3,1
?#???#???#..???##??. 9,4
?##?#..#?.??# 4,1,2
#??.#????????#? 3,3,1,1,2
?#???###..#?#.?.#?#? 3,3,1,1,4
???#?.????#???.? 1,8
.?????##?????.#? 1,2,1,1,2
????#..?.#?#?..?# 5,1,4,1
??????..???#??.???? 1,1,1,1,3,2
?###???##????.?? 13,1
.?#????????.?.#. 4,4,1
??##?##????.#??.? 1,9,3
..???#??????????#?. 1,1,10
.###.?#..????? 3,1,2,1
?#?.??????##??#? 2,11
.?#????.?? 2,2,1
??#?#####????#.???? 1,1,8,1,1,1
.???..??????#?.? 2,5
??#?????##???.??. 1,1,7,1
???.?..##.?.?#?.?? 3,1,2,1,1,1
..#????.#??.#?## 2,1,1,4
?#?##??????????? 6,6
?.#??.#.?... 2,1
.??#??.??#??# 2,1,2,1
??.??#?#?.???.#???? 1,5,1,1,2
?#?.??.?#??????????. 2,1,11
?????##???? 1,6
.??.?##???.???.?. 1,4,1,3,1
?#.??????####???.? 1,4,8
???#????#?????.? 8,1
?.???????? 1,1,1
???#??#?#??#?#.?? 1,2,4,3,2
#.?????#??##.?.? 1,1,6,1
?#?.?##..???# 2,2,3
#??#???#?.?.??? 4,1,1,1
#?#???.????#?##?? 1,1,1,9
.???#?#?.?..?# 4,1
.????##?#?#??? 1,9
#??.?####?.?.??.?? 3,5,2,1
???#?????..?##?##?? 6,5
..?.#????#?#.?? 2,2,1
?????.??.?#.# 1,2,1,1
.?#??#??#.?.?? 2,5,1
???????#?????##??.? 8,6
?#??????.#?##?? 4,1,5
?.?????.?? 4,1
?#?#???.??. 5,1
?.????.??? 4,1
?#???#??#.??..?# 2,3,1,1,2
??????####?.? 1,6
.?#?.?#??#???? 2,5
??.??#???????#??? 1,13
?#??##??.??#?????. 6,6
?????#??#????? 5,4
#???#?#?#???#?..???? 7,1,3,2
?#??#??#?#????????? 11,2
#?????.???? 2,3,2
.#??.????##.?. 3,1,2,1
????????#?????##? 3,4,1,3
??##?#?#.?????? 7,1
.#???#???#???#?# 7,1,1,1,1
??.?.?.?.??#??.? 1,1,5
??????#??#??##? 1,1,9
...#.??#???#??. 1,3,3
????#?????. 7,2
????#???????.#?#..# 1,1,8,1,1,1
?#?#??.?#?? 2,3,1
??#?.?#.???????.?? 3,1,1,1,1,1
.?#?#?.??##? 5,3
?##??#?.#? 2,1,2
#???#????##.???. 3,7,2
.??##??#????????. 8,1
??#????#?..#?#????. 5,2,1,4
???#????..????. 5,2
??.???.??.#?.? 1,1
?#??.????? 1,1,1
???#?????.?..#. 4,3,1,1
??#?#???##?????????# 7,2,3,1,2
???##???#.??? 1,3,2,3
#.???????# 1,3,2
..#???.#????? 2,4
?#?.??.?.??#.? 2,1,1,2
??.?.???#???# 1,1,6
#??????????#??.?.? 1,2,5,2,1,1
.??????????#???#? 8,6
??????????#?#???? 1,10
???#???..??.?.?? 4,1
.???#???#???#?? 1,1,2,1,1
???.?.#???#???. 1,1,6
..??#??????.. 3,4
#??.?#.????##??#? 2,2,1,2,3
???#?.?.?.?.??? 2,1,1,1,1
??????#?????.? 1,5,1
?##.??..?#??#???## 3,1,5,3
???#?#?????????#?? 10,2,1
.??##?#??#??#?????? 1,2,2,4,1
.???????#?. 5,1
#?#?#??.???#???#.## 1,1,2,8,2
???##???.??????????? 7,3,4
?#?????.???????## 2,1,3,4
???#..?????. 1,1,1,1
.???#??.?#?# 1,3,4
.?###???????.??? 9,1,1
???????##??.?? 10,1
.??.????#??.?? 1,2,2,1
?????##?#??? 2,5
?.???????.?# 1,2,1,1
?..?????#? 1,7
??...?..?????.?? 1,3
.???????.#?.??? 6,2
?????.??#???.?#? 1,1,4,1
??#.?.?#??#? 1,1,6
.??..##..???#?#? 2,2,6
?.??#????? 1,1,2
???##???#??#?#??? 1,2,1,7,1
#??.???????#? 2,5,1
#????#??#..?.? 3,1,1,1
???#??#??..?????#??? 1,6,1,4,1
?.??#..????#????. 1,3
???#??.#.?##?#??#??? 1,1,1,1,8,1
????##???????#? 3,4,3
#.?????#????.? 1,8
?.#???????.?? 3,2
?#??????#? 3,4
#???#??.??#???.??#? 1,1,1,1,5,1
????##??#?.???#?.. 4,2,1,2
?.???#???????#???? 7,5
.??#????????#.?. 1,1,1,1,3
?????????..?####??? 6,6
???.?????? 2,3
?.?#???.?..?.???#.#? 1,4,1,3,1
??.??#.?.?#??? 1,1,5
?#.?#?.#????.?# 1,3,1,1,1
.?#?????.??? 3,1,1
??#?.?.?..#?? 3,1,2
??#??#?####.????. 1,1,7,1,2
#?????#?#? 1,1,3
?##.??????#.. 2,7
..??????.??##?#?# 1,1,1,7
.?.?????#? 1,2,1
??????##???.?..????. 5,2
???????#?... 1,2
???#????????. 1,3,2
.?#???###??#???? 8,3
???#.??#??????? 2,8
???#???.??.??###?? 1,1,1,1,7
#??.?????.###? 1,1,2,3
#.?#????#???#?.?#??? 1,2,4,2,4
?.?#???.##?? 2,2
???#??..?#.???? 2,2
???????????##?????? 5,10
.?????#.????##? 4,6
????????????? 8,1
?..???#?.#??.#? 1,1,2,2
??.???#?#??# 1,1,1,2
?#?##?????????##? 4,2,4
?#?????????????? 9,2
?#.###????#???? 2,3,3,1
.????????.?#??#?? 2,1,1,2,3
???##???.??#??.???? 7,2,3
??#????#???.?????? 2,3,3
#?.????##? 2,1,3
?#??????#??####?. 1,2,1,5
.?...??.?#???.???. 1,2
.???.#???.#?#???.?? 1,1,1,5,2
?????#??### 1,7
????#?..????##??.?? 5,6
???????.##??..# 1,1,1,4,1
???.?##?..??.?#??? 3,4
??#???????#????#? 3,1,7
??..???..##. 2,2,2
???.?#??#???? 2,5
??#.?#??#?? 1,1,3
????#.#?#???????# 1,1,7,1,1
???##?##???.?#????#? 8,3,2
??????#??...??????#? 3,4,7
?#?##??.????????.. 4,1
???#?#?####?. 2,1,5
???#?#.##????..?? 3,1,3,1,1
??#???#?##????.???? 3,7,2,3
??.???.???.#.? 1,1,1,1
.#????.??#?#?????? 5,5,2
.?#??.???.??? 4,1,1
??????#??????###? 3,6,4
.#?.???#?? 2,1
?????#?????.?.???? 7,1,1,2
??#?##???.? 8,1
???###???#??.??????? 9,1
..?##..#???#?#?#?#?? 2,7,3
???#?????.#????? 4,5
?.?#????#?????#??#? 2,11
.#?#??.?##?...?? 1,1,4,2
????.??.?.??# 1,1,1,2
##???.#?#. 4,3
?????##?##?#????#. 1,6,1,3
??????.#??# 1,1,4
#???.??.#? 1,1,1
##??????..??? 4,1,1,2
??#?????????#?#? 2,4,6
?.??????#??#? 1,1,1,2
???.#??#???????.?? 2,1,1,1,4,1
???.?????. 1,1,1
???###???????#?#???? 6,8
???????.?????#?#? 5,1,1,4
?###??#...###???#?#? 4,1,7,1
#.?.?#?.?.?????# 1,1,2,4,1
??.??.????#??#?#? 1,1,1,5,1
?#.??????? 2,1,1
??????#?#???.????? 2,4,2
.???#?????.??.#?# 9,3
?.?..?????? 1,2,1
??????.?.?.#?????? 6,1,7
#??????##???. 1,9
?#????????.?.?.#? 5,1,1
?#??#???#?????? 1,3,5
.?????##????.??## 2,7,4
##?.??.??? 2,2,1
?.?#????##??. 1,3
.????.?#?? 1,2
.?##??.#????#?? 2,7
?.?.?#????##?##. 1,2,5,2
?????.???.#? 1,1,1
?##???.?.? 5,1,1
?#?#?..?.?##?? 5,1,4
.?#..??#????#?? 1,8
??.#??#????? 1,4,1,2
?#.????????. 2,1,2
#?????.?????##???# 6,1,4,1
????...????? 2,3
???#??.??????? 1,3,2,1
##???????#??? 2,8
?#?#???????#????#?.? 1,6,8,1
.??.?.??#??.? 1,1,4,1
??????#?..??. 6,1
.???#?????????? 1,3,1,3,2
??.?#?.???..?#? 2,1,1,1,2
#?#??????###?#???? 14,1
????.????? 2,1,1
##.?????#??#?. 2,2,1,2
.??#?.?#?#.? 2,4
??????#?#?? 2,5
??.???#???????.???? 1,4,2,1,1,1
?#.??#?.#???#???? 1,3,1,1,2
?#???..??? 1,1,1
?.??.????.. 2,1
#?.????#.??.???????# 2,1,1,1,1,4
#?##????##?????? 1,4,2,3,1
#??##?????#??? 1,4,1,1
.?????#????#?#?#?? 1,1,4,5,1
????.??????. 1,3
???.#??????????. 1,4,2,3
??##?#?#??????????? 11,2,3
??.??##??.? 1,4
????????.#.?. 7,1
???????????????.?#?? 1,1,4,3,2
????.?????..???. 5,1
?????#?#?.?##???. 3,5
..??..????##.?.???. 6,2
?????##?.#?????#?.?? 6,1,1,3,1
????.????.# 2,2,1
??#????????.?? 6,1,1,1
???????..#????#??.#? 3,1,7,1
??...##??? 2,3
????##???#????.?? 2,7,1,2
????##????.??#??#. 6,5
???.?#??.?#?#?#?. 2,4,3,1
.#.??.???? 1,1,1
??.?#..?.??##?.???.? 1,3
??#?.????. 2,1
???#?#.###?#.?.??? 5,5,1,1
#????????????? 4,1,3
.#???????? 1,1,1
??????#????#?#? 1,1,9
????#?.#?? 3,1
??#.#?..#.?#.??.?? 3,2,1,1,1,1
?.?????#??????.?. 2,4,1
.???..?.????#? 3,1,1,1
.#?#??#??????????## 4,4,1,3
.#?..?#?????.? 1,3,2
???.??????#??..#.??. 7,1
???.??????.?? 1,1,3,1
??????#??#??#? 1,1,5,1
?#???##??#?.?.??.?.? 3,6,1,1,1,1
???#?#???.??#???. 5,2
??##?#??????.. 6,2
.??????????#? 1,5
?#?#??#?## 6,2
?#.?.#????#??#? 1,1,1,7
??????#??? 1,1,1
?.##???#??. 2,3
??..#??#??## 1,2,1,2
?#?..?????#??#? 3,9
??#..#?#????????? 1,1,1,1,8
#??#?????????####? 1,1,6,6
#?#?#??.???????#??# 5,1,1,3,1,2
.????##?.???#????#? 7,4,1,2
?#??..??#. 1,1,1
??????..#??. 3,2
??#????.????#??.? 3,1,1,4,1
??????????#???..? 1,4,1,1,1
.#??.?#????#.?#? 1,2,4,1
????###????? 5,2
?????#?.?? 6,1
.?.?##??.????? 1,4,1,2
????#.????????? 4,1,2,2
??.???#????##??????? 10,4
?#?????#?.?? 1,1,1,1
.?.?.?..??#???.? 1,1,1,4,1
??????..#.#??? 2,1,2
.??##??#?. 3,3
?.?#???#?????#??# 1,2,3,5
???##????#???.?#??#? 7,2,1,1,2
##???..????. 3,1,4
#?##?.????????.?? 4,7
.??.#???.. 1,3
??#???##????#????? 1,3,2,1,2
#....??#?.#?# 1,3,3
???.?????????? 2,2,3
?#.#.?#.?#?? 1,1,1,2
?.?#??##??????.? 6,2
#???#??????.???? 5,1,3
.???#?#???????#???#? 1,4,2,3,1,2
.????..???..? 4,3,1
?#????.???#??? 4,1,1,1
.??????.?#.?? 2,1,2,1
.???..??.# 1,1,1
#??.?#?#??? 1,6
???#??????????..?. 9,2,1
.#????.??#?.?? 2,1,3
.????#.???? 5,2
?.#????#.????? 2,2,1,2
#?????#?#?????? 1,8,1
??????#?#?? 2,3,2
??.???.?.???????? 1,3
???.#???.?#???? 3,1,1,1,1
.??.????#???.?. 1,7
????.#??????? 1,2,4
?????###??? 1,7
???#???###.???.?? 8,2
??#?????#???? 2,2,1,2
#####????.????? 6,1,1
??#??#???????#? 6,1,2
?#?#???????#??? 5,3,1,1
?.?#?#???#???..??? 1,1,7,1,1
?#.#????????###?? 1,12
?.???????.#? 1,3,2,2
.?????.#??? 4,1
#???..?????? 4,1,3
?.#####????..?? 6,2
?#?..?.#?.?????.? 2,1,2,4
???.??.????. 1,1,1,1
.?##????#? 4,2
??????????.??? 2,1,2,1
?????????#?#?## 2,3,1,4
.?..???#??? 4,1
??#?.?###? 2,3
..#?..??#??##### 2,3,6
??#???.????#? 4,1,3
????#?#??.?#?.?### 7,1,3,3
?#????#?#. 1,3,1
??#???#?##?..#.??. 11,1,1
????#??#?????#????.? 2,6,4,1
.??#?.???????????.?. 1,1,5,3
.??####?#?????#.? 10,1
?#???????#????????? 10,5
.#??????#. 1,4
?.#???????. 4,1
#??????#???.?#? 2,1,1,1,2
???#?????? 4,1,1
?#????#????????????? 2,6,1,1,1,1
#????##???#???#??? 1,1,2,6,1
.?.?#?#???.??#???? 1,4,1,1,2,1
??????#?###????? 6,2
?...?#??#???? 5,1
?.?????.?? 1,1,1
.??...?### 1,4
??????.????#??##?? 1,1,1,3,4
#?.?.??#.?#? 1,1,3,3
????#.?????#?????# 1,1,11
??.???.??..#?.# 1,1,2,2,1
?#??.????###?##?.?.# 2,1,1,7,1,1
???##???#?.? 5,3
??#????????.?.?.?? 6,1,1,2
#.?.?#.?.??? 1,1,1,2
??.?#####?#??#?#??.? 15,1
#.?.?..##?#?. 1,1,5
?????#?##????.? 1,8,1
??#??????#??.? 2,8
?#?#??#???? 5,3
????.?#???? 1,2,1
.??#???#???# 2,6
..?#????????.. 4,2
??.?#??#?? 2,1
?.?????##? 1,6
.????#??#.?#.?? 7,1,1
.#????????#??#???#?? 11,1,1,1
??##??#??????? 5,2
.?????#.#?#??#?#?? 1,1,1,6,1,1
###??.#.#?#.#..?? 5,1,3,1,1
???#?.??.?#??#? 1,3,1,1,2
.?#.?#??#????.?.. 2,4,2
.????#?##????????##? 15,2
#.???#?#???.??????? 1,7,1,1,1,1
??.?.?##??.?###.???. 2,4
?.????.#?#? 2,3
.????.??#?#? 2,5
?.?.#????? 1,3
.#?#??.??#?#???# 1,2,9
????#???#? 5,1
#????..?#????????#?? 1,1,11
#..????.?#???.?? 1,2,2,2,1
??.#.????.? 1,1
?.##.###??.????#. 1,2,4,1,1
##???????.???# 9,1,1
?#??????.? 2,1
????.?#?#???.#.?#?. 2,4,2,1,2
???#?.??.?.??##?.?? 4,2,1,3,2
????##??#?.??? 6,2
?????#??????#??#? 2,2,9
????????.??? 4,1,1
?.?...?.#????#?????? 1,1,1,4,1,2
??#?.??##?. 4,5
.?#?#?????#?#????# 1,1,1,8
??????#.???. 1,1,1,1
.???????????#? 10,2
??##?????.?#?? 6,3
?..??????????.#????? 2,2,4
.??#???.??? 1,3,2
?.???????.?? 1,1,4
???.?#.#?###???? 1,1,9
?#?????.###??.? 4,5
????#?###?????? 10,2
#????#?#??????##?#? 1,16
.?#?.??.?..?# 2,1,1,1
???#??#??????#?????? 4,7
?##??#????.???? 3,1,1,1,2
???????..?? 1,2,1
??.?##.?.??#??.?. 2,4
?.?#?.????#??#?#???. 1,3,1,10
???????????? 1,3
?.?.#????#????? 1,1,6
.?.??????.?# 1,2,2,1
#??##????#????..? 2,7,2,1
?#?#???????.?? 6,3,1
.??##?##??????#?? 8,1,1,1,1
???######.?.?? 8,1
??#?.?????? 3,1,1
.??##?.?????#?? 5,1,1,1
?.???..????#??? 1,1,1,2,1
.#???.?#??#.?#? 3,3,1,1
?.?#?.??#??##?????.? 3,2,4,3
#???????##?#?? 3,6
.?#?#.?##.??. 4,3,2
????????????#????.# 1,1,1,3,6,1
??##????.???##? 4,1,6
?#??.?#?##?.. 1,4
???#??????#?#?.???? 2,2,1,5,2,1
????#??#?#.#??????. 1,7,2,1,1
.???#?.?##???#??#?? 5,3,4,1
??##?.#..?#?????# 4,1,5,1
???#???..? 4,2
???????????##?##??#? 5,2,6,2
???#???.????.. 6,2
?.#.#???#?#?? 1,1,7
.??.?#??..???#???.? 2,6
#????????#??#??#? 1,14
..??#????????#?? 6,3
.???.?#..##???.?? 1,1,4
??.??????.#?#?#..??? 1,5
?#??#?#???? 1,5,2
..??????.. 2,1
?.#?.??#..???#? 2,1,1,1,1
..??????????? 1,2,1
???#?.????? 2,5
??##?????#?.?????? 3,1,3,3,1
#?.??.??#..? 2,1,1,1
?#?????#????##???? 1,12
?#??????.??????###?? 2,2,1,7,1
???...#.?##.#? 2,1,2,1
??????.???##???.? 2,3,7
?.????###?????. 8,1
?.???????.?????????? 1,1,2,8,1
?????????? 1,1,2
?#?#??##?#?#???.?#?. 5,6,2
.?#..???#.?????. 2,2,1,1
???????????.#??? 3,3,1
?.??##.??????? 1,2,3,1
.????#??#?#?##?????? 11,1
.?#???#.?##?#?.?#?? 6,4,2
?#?#?.#.#???..??? 4,1,4,1,1
?##??#???###??#?. 6,6
.#????.#?. 2,1,1
?????##??##?. 2,7
?.??????#?#? 1,1,5
.???#????????#? 2,3,3
.?#?????#?#??##.? 3,9,1
.?..??##????????? 1,5,3,1
??.??#?????? 2,5
#?.??#?.#.?.??????# 1,4,1,1,7
#????#????.????#? 1,1,3,4
.?##????#.??? 3,2
??.????###????.??#? 1,8,1,1,1
?#??????????##.## 4,1,1,3,2
?????#?#.#?.??.? 2,2,1,1,1
.?.?#???.?#????#?#? 3,1,7,1
?.?##????#???#..? 1,6,1,1,1
#?#?.??#?#.. 3,1,1
????#??.???? 2,2,1,1
?.?????#?.??.? 1,2
##????.??.?. 4,1
.?#?????.? 1,1,1
??.?????????.. 3,1
.#??#?#??.?#? 6,1,3
???#?????? 1,1,1
?.?.??.??? 1,3
?????#??#?#??..#? 9,1,1
##??.???#??##?? 4,1,2,1
?.#??????.?#???.?#. 4,3,2
#??##??.???????????? 7,4,1,1
?????..??..?. 1,1
#??#.???.?.#? 4,1,1
????#?#??.??#?.?#?? 6,3,2
?#??#?.???????? 1,3,7
????###???#??????# 11,1
##??.??#?#???#???#? 4,1,9
.??#???..#?#???#???? 1,1,2,1,1,4
??.??..??#?????# 1,7,1
#?.?.#????????# 2,2,3,1,1`.split("\n");

function log(u: unknown) {
  console.log(JSON.stringify(u));
}

function numStringToArray(src: string): number[] {
  return src
    .split(",")
    .filter((s) => s.trim().length > 0)
    .map(Number);
}

function validPositions(template: string, groups: number[]): number {
  let sum = 0;
  const q: [[string, number[]]] = [[template, groups]];
  while (q.length > 0) {
    const [t, g] = q.pop() ?? ["", []];
    //  log({ t, g });

    if (t.length === 0) {
      if (g.length === 0) {
        sum += 1;
        continue;
      }
    }

    if (g.length === 0) {
      if (!t.includes("#")) {
        sum += 1;
        continue;
      }
    }

    if (t.length >= g.reduce((a, c) => a + c, 0) + g.length - 1) {
      const c = t[0];
      if (c === "?") {
        q.push(["." + t.slice(1), g]);
        q.push(["#" + t.slice(1), g]);
      }

      if (c === ".") {
        let i = 1;
        for (; i < t.length; i++) {
          if (t[i] !== ".") {
            break;
          }
        }
        q.push([t.slice(i), g]);
      }

      if (c === "#") {
        const [cr, ...rem] = g;
        let i = 0;
        for (; i < cr; i++) {
          if (t[i] === ".") {
            break;
          }
        }
        if (i === cr) {
          if (t[i] !== "#") {
            q.push([t.slice(cr + 1), rem]);
          }
        }
      }
    }
  }

  return sum;
}

const cache: Map<string, number> = new Map();

function validPositionsRecurse(template: string, groups: number[]): number {
  const key = JSON.stringify({ template, groups });
  const entry = cache.get(key);
  if (entry != null) {
    return entry;
  }

  const [t, g] = [template, groups];
  //  log({ t, g });

  if (t.length === 0) {
    if (g.length === 0) {
      cache.set(key, 1);
      return 1;
    }
  }

  if (g.length === 0) {
    if (!t.includes("#")) {
      cache.set(key, 1);
      return 1;
    }
  }

  if (t.length >= g.reduce((a, c) => a + c, 0) + g.length - 1) {
    const c = t[0];
    if (c === "?") {
      const sum =
        validPositionsRecurse("." + t.slice(1), g) +
        validPositionsRecurse("#" + t.slice(1), g);
      cache.set(key, sum);
      return sum;
    }

    if (c === ".") {
      let i = 1;
      for (; i < t.length; i++) {
        if (t[i] !== ".") {
          break;
        }
      }
      const sum = validPositionsRecurse(t.slice(i), g);
      cache.set(key, sum);
      return sum;
    }

    if (c === "#") {
      const [cr, ...rem] = g;
      let i = 0;
      for (; i < cr; i++) {
        if (t[i] === ".") {
          break;
        }
      }
      if (i === cr) {
        if (t[i] !== "#") {
          const sum = validPositionsRecurse(t.slice(cr + 1), rem);
          cache.set(key, sum);
          return sum;
        }
      }
    }
  }

  return 0;
}

function part1(input: string[]) {
  const counts: number[] = input.map((r) => {
    const [template, groupString] = r.split(" ");
    const groups = numStringToArray(groupString);

    return validPositions(template, groups);
  });

  log(counts);
  log(counts.reduce((a, c) => a + c));
}

function part2(input: string[]) {
  const expanded: [string, number[]][] = input.map((r) => {
    const [t, g] = r.split(" ");
    const groupString = new Array<string>(5).fill(g.trim()).join(",");

    const newT = new Array<string>(5).fill(t).join("?");

    const newG = numStringToArray(groupString);

    return [newT, newG];
  });

  // log(expanded);
  const counts: number[] = expanded.map((r, i) => {
    log(`${i + 1} / ${expanded.length}`);
    const [template, groups] = r;
    return validPositionsRecurse(template, groups);
  });

  log(counts);
  log(counts.reduce((a, c) => a + c));
}

// part1(puzzle_input);
part2(puzzle_input);
